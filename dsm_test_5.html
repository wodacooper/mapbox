<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<title>Des Moines Test Map</title>
<meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" type="text/css">
<!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<script src="https://kit.fontawesome.com/9a358cbeb3.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; }
</style>
</head>
<body>
<script>

function updateNumericFilter(target) {
    const value = parseFloat(target.value)
    const splits = target.id.split('@');
    const cat = splits[1];
    const layer = splits[0];
    let p = 1;
    if (splits[2] == 'to') p=2;
    let j = layers[layer].num_filters.indexOf(cat)*2 + p;
    if (layers[layer].cat_filters) j = j + layers[layer].cat_filters.length;
    const clear_btn = document.getElementById(layer.concat('@',cat,'@clear'))
    if (clear_btn.classList.contains('hide')) {clear_btn.classList.remove('hide')};
    layers[layer].filters[j][2] = value
    console.log(layers[layer].filters)
    for (type of layer_types){
        if (layers[layer][type]){
            map.setFilter(layer.concat('@',type), layers[layer].filters);                  
        }
    };
}

function controlFromInput(fromSlider, fromInput, toInput, controlSlider) {
    const [from, to] = getParsed(fromInput, toInput);
    fillSlider(fromInput, toInput, '#C6C6C6', '#128ed6', controlSlider);
    if (from > to) {
        fromSlider.value = to;
        fromInput.value = to;
    } else {
        fromSlider.value = from;
    }
    updateNumericFilter(fromInput);
}
    
function controlToInput(toSlider, fromInput, toInput, controlSlider) {
    const [from, to] = getParsed(fromInput, toInput);
    fillSlider(fromInput, toInput, '#C6C6C6', '#128ed6', controlSlider);
    setToggleAccessible(toInput);
    if (from <= to) {
        toSlider.value = to;
        toInput.value = to;
    } else {
        toInput.value = from;
    }
    updateNumericFilter(toInput);
}

function controlFromSlider(fromSlider, toSlider, fromInput) {
  const [from, to] = getParsed(fromSlider, toSlider);
  fillSlider(fromSlider, toSlider, '#C6C6C6', '#128ed6', toSlider);
  if (from > to) {
    fromSlider.value = to;
    fromInput.value = to;
  } else {
    fromInput.value = from;
  }
  updateNumericFilter(fromSlider);
}

function controlToSlider(fromSlider, toSlider, toInput) {
  const [from, to] = getParsed(fromSlider, toSlider);
  fillSlider(fromSlider, toSlider, '#C6C6C6', '#128ed6', toSlider);
  setToggleAccessible(toSlider);
  if (from <= to) {
    toSlider.value = to;
    toInput.value = to;
  } else {
    toInput.value = from;
    toSlider.value = from;
  }
  updateNumericFilter(toSlider);
}

function getParsed(currentFrom, currentTo) {
  const from = parseInt(currentFrom.value, 10);
  const to = parseInt(currentTo.value, 10);
  return [from, to];
}

function fillSlider(from, to, sliderColor, rangeColor, controlSlider) {
    const rangeDistance = to.max-to.min;
    const fromPosition = from.value - to.min;
    const toPosition = to.value - to.min;
    controlSlider.style.background = `linear-gradient(
      to right,
      ${sliderColor} 0%,
      ${sliderColor} ${(fromPosition)/(rangeDistance)*100}%,
      ${rangeColor} ${((fromPosition)/(rangeDistance))*100}%,
      ${rangeColor} ${(toPosition)/(rangeDistance)*100}%, 
      ${sliderColor} ${(toPosition)/(rangeDistance)*100}%, 
      ${sliderColor} 100%)`;
}

function setToggleAccessible(toSlider) {
  if (Number(toSlider.value) <= Number(toSlider.min) ) {
    toSlider.style.zIndex = 2;
  } else {
    toSlider.style.zIndex = 0;
  }
}    
</script>
<style>
.range_container {
    display: flex;
  flex-direction: column;
  width: 90%;
  margin: 10px auto;
}

.slider_control {
  position: relative;
  min-height: 30px;
  padding-top: 10px;
}

.form_control {
  position: relative;
  display: flex;
  justify-content: space-between;
  font-size: 24px;
  color: #635a5a;
}

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  pointer-events: all;
  width: 12px;
  height: 12px;
  background-color: #fff;
  border-radius: 50%;
  box-shadow: 0 0 0 1px #C6C6C6;
  cursor: pointer;
}

input[type=range]::-moz-range-thumb {
  -webkit-appearance: none;
  appearance: none;
  pointer-events: all;
  width: 12px;
  height: 12px;
  background-color: #fff;
  border-radius: 50%;
  box-shadow: 0 0 0 1px #C6C6C6;
  cursor: pointer;  
}

input[type=range]::-webkit-slider-thumb:hover {
  background: #f7f7f7;
}

input[type=range]::-webkit-slider-thumb:active {
  box-shadow: inset 0 0 3px #387bbe, 0 0 9px #387bbe;
  -webkit-box-shadow: inset 0 0 3px #387bbe, 0 0 9px #387bbe;
}

input[type="number"] {
  color: #8a8383;
  width: 50px;
  height: 30px;
  font-size: 20px;
  border: none;
}

input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button {  
   opacity: 1;
}

input[type="range"] {
  -webkit-appearance: none; 
  appearance: none;
  height: 2px;
  width: 100%;
  position: relative;
  background-color: #C6C6C6;
  pointer-events: none;
}

#fromSlider {
  height: 0;
  z-index: 1;
}  
</style>

<style>


    .dropbtn {
        background-color: #128ed6;
        color: white;
        padding: 10px;
        width:220px;
        border: none;
        font-size: 16px;
        
        cursor: pointer;
    }

    .clearbtn {
        background-color: #ddd;
        color: #128ed6;
        padding: 4px;
        font-size: 10px;
        position:absolute;
        right: 5px;
        top: 17px;
        border: none;
        border: 1px solid #ddd;
        cursor: pointer;
    }

    .dropdown-content input[type='text'] {
        box-sizing: border-box;
        background-position: 14px 12px;
        background-repeat: no-repeat;
        font-size: 16px;
        padding: 10px 0px 10px 10px;
        border: none;
        border-bottom: 1px solid #ddd;
    }

    .dropdown-content input[type='text']:focus {outline: 3px solid #ddd;}

    .dropdown {
        position: relative;
        display: block;
        width:220px;
    }
    .filters {
        position: relative;
        display: block;
        width:220px;
        display: none;
        max-height: 0px;
    }

    .toggle_checkbox{
        position:absolute;
        right: 5px;
        top: 17px;
        cursor: pointer;
    }

    .dropdown-content {
        overflow-y: auto;
        border: 1px solid #ddd;
        width:220px;
        max-height: 0px;
        background-color: #fff;
    }

    .dropdown-content input[type='checkbox'] {
        display: none;
    }
    
    .dropdown-content input[type='checkbox'] + label {
        background-color: #fff;
        display: block;
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
    }

    
    .dropdown-content input[type='checkbox'] + label:hover,
    .dropdown-content input[type='checkbox']:checked + label {
        background-color: #fff;
    }
    
    .dropdown-content input[type='checkbox']:checked + label:before {
        content: 'âœ”';
        margin-right: 5px;
    }

    .dropdown a:hover {background-color: #ddd;}


    .box {
        float: left;
        height: 20px;
        width: 20px;
        margin-bottom: 15px;
        border: 1px solid black;
        clear: both;
    }

    .calculation-box {
    height: 40px;
    width: 50px;
    position: absolute;
    bottom: 50px;
    left: 40px;
    background-color: rgba(255, 255, 255, 0.9);
    padding: 10px;
    text-align: center;
    }
    
    .legend-box {
        position: absolute;
        right: 5px;
        bottom: 20px;
        max-width: 200px;
        max-height: 400px;
        overflow-y: auto;
    }
    .legend {
        overflow-wrap: anywhere;
        display: none;
        padding: 5px;
        border: 1px solid #ddd;
        max-height: 0px;
        background-color: rgba(255, 255, 255, 0.9);
        font-weight: bold;
    }

    .legend-list { list-style-type: none; margin: 0; padding: 0px;}
    .legend-list li {padding: 0px; font-weight: normal; }
    .legend-list span { border: 1px solid #000000; float: left; width: 12px; height: 12px; margin: 2px; }

    .popup-box {
        max-width: 300px;
        max-height: 300px;
        overflow-y: auto;
    }

    .popup-box p {
        margin: 0;
        padding: 0 0 5px;
    }

    .popup-box h3 {
        margin: 0;
        padding: 0 0 5px;
    }

    .popup-box h4 {
        margin: 0;
        padding: 0;
        color: #aaaaaa    
    }

    .show {display: block; max-height: 200px;}

    .show input[type='range'] {position: absolute;}
    .show_filters {display: block;max-height: 800px;}
    .hide {display: none;}

    .gray {background-color: #aaaaaa;}


</style>
<div id="map"></div>
<div id="layer_list"></div>
<div id="legend_box" class = "legend-box"></div>
<div class="calculation-box">
    <div id="calculated-area"></div>
    </div>
<script>

    
    async function get_json() {
            const query = await fetch(
                'https://wodacooper.github.io/mapbox/ia_24_layers.json',
                { method: 'GET' }
            );
            const data = await query.json();
            console.log(data)
            return data
    }


    var bing = {
        score:{
            name: '2024 Score',
            source_id:'dsm_test',
            url: 'mapbox://ewright81.ia_24',
            source_layer: 'hello_world',
            layout: {'visibility':'visible'},
            visible: true,
            fill: {
                    'fill-color': [
                    "match",
                    ["get", "score"],
                    8,
                    "#00ffff",
                    7,
                    "#00ffff",
                    6,
                    "#00ff00",
                    5,
                    "#ff00ff",
                    4,
                    "#ffff00",
                    "#ffffff"
                    ],
					'fill-opacity': 0.5
                },
            cat_filters: ['set_aside', 'city', 'county'],
            num_filters:['score'],
            legend: [
                ['7 - 8',"#00ffff"],
                ['6',"#00ff00"],
                ['5',"#ff00ff"],
                ['4',"#ffff00"]
            ],
            hover:[
                ['set_aside', false],
                ['county', false],
                ['city', true],
                ['location_boost', true],
                ['score', false],
            ],
            click: ['set_aside', 'county', 'city', 'score','underserved_pts', 'rent_burden_pts', 'active_dev_pts','jobs_pts', 'vulnerability_pts', 'thriving_pts','qct_boost','rural_boost']
        },
        cities:{
            name: 'Cities',
            source_id:'places',
            url: 'mapbox://ewright81.ia_places_24',
            source_layer: 'hello_world',
            layout: {'visibility':'visible'},
            visible: false,
            line: {'line-color': '#FFFFFF'},
            fill:{'fill-opacity': 0.4},
            cat_filters: ['CLASSFP', 'city', 'underserved_pts'],
            legend: [['City Limits','#ffffff']],
            hover:[
                ['city', false],
                ['CLASSFP', true]
            ],
            click:['burden_pts']
            //to be added: click and hover categories
        }
    }

    const layer_list = document.getElementById('layer_list');
    const legend_box = document.getElementById('legend_box');


    var allow_click = true;
    var circle_mode = false;
    var drive_mode = false;
    var init_filters = true;
    const layer_types = ['fill','circle','icon','line']
    var hover_layers = [];
    var click_layers = [];
    var layers;
    
    
	mapboxgl.accessToken = 'pk.eyJ1IjoiZXdyaWdodDgxIiwiYSI6ImNscXpkbjFoaDA0Y2gybG1jOXV6NWhtZnoifQ.-DFzbjn9lq0ysVbY1HshJQ';
    const map = new mapboxgl.Map({
        container: 'map',
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: 'mapbox://styles/mapbox/satellite-streets-v12',
        bounds: [[-96.58859136144741, 40.343619780357525], [-89.95865987289943, 43.564125073484746]]
    });

    

    map.on('load', () => {
        get_json().then(data => {
            layers = data;
        
            for (const layer of Object.keys(layers)){

                map.addSource(layers[layer].source_id, {
                    type: 'vector',
                    url: layers[layer].url
                });
                for (type of layer_types){
                    if (layers[layer][type]){
                        map.addLayer(
                            {
                                'id': layer.concat('@',type),
                                'type': type,
                                'source': layers[layer].source_id,
                                'source-layer': layers[layer].source_layer,
                                'layout': layers[layer].layout,
                                'paint': layers[layer][type]
                            }
                        );                   
                    }
                };

                if (layers[layer].hover) {
                    for (type of layer_types){
                        if (layers[layer][type]){
                            hover_layers.push(layer.concat('@',type));
                            break;        
                        }
                    };
                };

                if (layers[layer].click) {
                    for (type of layer_types){
                        if (layers[layer][type]){
                            click_layers.push(layer.concat('@',type));
                            break;        
                        }
                    };
                };

                const leg_dict = layers[layer].legend;
                if (leg_dict){
                    
                    const legend_div = document.createElement('div');
                    legend_div.id = 'legend@'.concat(layer)
                    legend_div.classList.add('legend');
                    if (layers[layer].visible){legend_div.classList.add('show');};
                    legend_div.innerText = layers[layer].name;
                    legend_box.appendChild(legend_div);

                    const legend = document.createElement('ul');
                    legend.classList.add('legend-list');
                    legend_div.appendChild(legend);
                    for (const pair of leg_dict){
                        const row = document.createElement('li');
                        row. innerHTML = `<span style="background-color:${pair[1]}"></span> &nbsp;${pair[0]}`;
                        legend.appendChild(row);
                    };
                };
            };
            const coordinatesGeocoder = function (query)  {
                const matches = query.match(/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i);
                if (!matches) {
                    return null;
                }
                const lat = Number(matches[1]);
                const lng = Number(matches[2]);
                const geocodes = {
                    center: [lng, lat],
                    geometry: {
                        type: 'Point',
                        coordinates: [lng, lat]
                    },
                    place_name: lat + ', ' + lng,
                    place_type: ['coordinate'],
                    properties: {},
                    type: 'Feature'
                };
                return [geocodes];
            }

            map.addControl(
                new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken,
                    bbox: [-96.58859136144741, 40.343619780357525, -89.95865987289943, 43.564125073484746],
                    localGeocoder: coordinatesGeocoder,
                    mapboxgl: mapboxgl
                })
            );
            map.addControl(
                new mapboxgl.NavigationControl({
                    showCompass: false
                })
            );

            const draw = new MapboxDraw({
                displayControlsDefault: false,
                // Select which mapbox-gl-draw control buttons to add to the map.
                controls: {
                polygon: true,
                line_string: true,
                trash: true,
                },
                // Set mapbox-gl-draw to draw by default.
                // The user does not have to click the polygon control button first.
                //defaultMode: 'draw_polygon'
            });
            map.addControl(draw, 'bottom-left');

            const controls = document.getElementsByClassName('mapboxgl-ctrl-bottom-left')[0].firstElementChild;

            const delete_btn = document.getElementsByClassName('mapbox-gl-draw_trash')[0]
            delete_btn.classList.remove('mapbox-gl-draw_trash', 'mapbox-gl-draw_ctrl-draw-btn')
            delete_btn.classList.add('fa-solid', 'fa-delete-left');

            const trash_btn = document.createElement('button');
            trash_btn.classList.add('fa-solid', 'fa-trash-can');
            //delete_btn.innerText = "X";
            trash_btn .addEventListener('click', () => {
                draw.deleteAll();
                updateArea();
            });
            controls.appendChild(trash_btn);

            const circle_btn = document.createElement('button');
            circle_btn.classList.add('fa-regular', 'fa-circle');
            circle_btn .addEventListener('click', () => {
                allow_click = false;
                draw.changeMode('simple_select')
                circle_mode = true;
            });
            controls.prepend(circle_btn);

            map.on('click', (e) => {
                if (circle_mode) {
                    const feature = turf.circle([e.lngLat.lng, e.lngLat.lat], 1, {units:'miles'});
                    console.log(feature);
                    const id = draw.add(feature);
                    console.log(draw.getAll());
                    circle_mode = false;
                }
            });

            const drive_btn = document.createElement('button');
            drive_btn.classList.add('fa-solid', 'fa-car');
            drive_btn .addEventListener('click', () => {
                allow_click = false;
                draw.changeMode('simple_select')
                drive_mode = true;
            });
            controls.prepend(drive_btn);

            async function getIso(e) {
                if(drive_mode){
                    const query = await fetch(
                        `https://api.mapbox.com/isochrone/v1/mapbox/walking/${e.lngLat.lng},${e.lngLat.lat}?contours_meters=1609&polygons=true&access_token=${mapboxgl.accessToken}`,
                        { method: 'GET' }
                    );
                    const data = await query.json();
                    console.log(data)
                    draw.add(data)
                    drive_mode = false;}
            }

            map.on('click', getIso);

            map.on('draw.create', updateArea);
            map.on('draw.delete', updateArea);
            map.on('draw.update', updateArea);


            
            function updateArea(e) {
                const data = draw.getAll();
                const answer = document.getElementById('calculated-area');
                const num_features = data.features.length
                if (num_features > 0) {
                    const feature = data.features[num_features-1].geometry;
                    if (feature.type == 'Polygon') {
                        const area = turf.area(feature);
                        const rounded_area = Math.round(area/4046.86 * 100) / 100;
                        answer.innerHTML = `${rounded_area} acres`;
                    } else {
                        const length_miles = Math.round(turf.length(feature,{units:'miles'}) * 100) / 100;
                        const length_feet = Math.round(length_miles*5280);
                        answer.innerHTML = `<div>${length_miles} miles</div><div>${length_feet} feet</div>`;
                    };

                    
                } else {
                    answer.innerHTML = '';
                };
            };

            const tooltip = new mapboxgl.Popup({anchor: 'top-left', closeOnClick: false, closeButton: false}).trackPointer()
                        
            tooltip.addTo(map)


            
            map.on('mouseleave', hover_layers, (e) => {
                tooltip.remove()
            });
        
            map.on('mousemove', hover_layers, (e) => {
                let table = ['<div style="line-height: 100%">']
                for (layer_name of hover_layers) {
                    layer = layer_name.split('@')[0];
                    if (map.getLayoutProperty(layer_name, 'visibility') == 'visible'){
                        feature = map.queryRenderedFeatures(e.point, {layers: [layer_name]})[0]
                        if (feature) {
                            table.push(`<h3 style="margin:0; padding:0 0 5px">${layers[layer].name}</h3>`)
                            const hover_cats = layers[layer]['hover'];
                            for (pair of hover_cats){
                                let value = feature.properties[pair[0]];
                                if (value){
                                    if (pair[1]) table.push(`<h4 style="margin:0; padding:0;color: #aaaaaa;">${pair[0]}</h4>`);
                                    table.push(`<p style="margin: 0; padding: 0 0 5px;">${value}</p>`);
                                }
                            };                        
                        }
                    }
                };
                table.push('</div>')
                tooltip.setHTML(table.join(''));
                if (!tooltip.isOpen()){tooltip.addTo(map)}
            });

            map.on('click', click_layers, (e) => {
                console.log(draw.getMode());
                if (draw.getMode() == 'simple_select') {
                    if (allow_click){
                        let table = ['<div style="line-height: 100%">']
                        for (layer_name of click_layers) {
                            layer = layer_name.split('@')[0];
                            if (map.getLayoutProperty(layer_name, 'visibility') == 'visible'){
                                feature = map.queryRenderedFeatures(e.point, {layers: [layer_name]})[0]
                                if (feature) {
                                    console.log(feature)
                                    table.push(`<h3>${layers[layer].name}</h3>`)
                                    const click_cats = layers[layer]['click'];
                                    for (cat of click_cats){
                                        let value = feature.properties[cat];
                                        if (value || true){
                                            table.push(`<h4>${cat}</h4>`);
                                            table.push(`<p>${value}</p>`);
                                        }
                                    };                        
                                }
                            }
                        };
                        table.push('</div>')
                        new mapboxgl.Popup({className: 'popup-box', anchor:'top-left'})
                        .setLngLat(e.lngLat)
                        .setHTML(table.join(''))
                        .addTo(map);
                        
                    } else {
                        allow_click = true;
                    };
                    
                } else {
                    allow_click = false;
                };
            });

            

            function updateLayerFilter(evt) {
                // get an array of icon names that corresponds to the currently checked checkboxes
                const splits = evt.currentTarget.id.split('@');
                const cat = splits[1];
                const layer = splits[0];
                const checkedSymbols = [...evt.currentTarget.parentNode.querySelectorAll('input')]
                .filter((el) => el.checked)
                .map((el) => el.id.split('@')[2]);
                const j = layers[layer].cat_filters.indexOf(cat) + 1;

                const clear_btn = document.getElementById(layer.concat('@',cat,'@clear'))

                if (checkedSymbols.length < 1) {
                    //dummy filter that will match everything to clear previous filter
                    layers[layer].filters[j] = ['!=', cat, '!!!'];
                    clear_btn.classList.add('hide')
                }
                else {
                    layers[layer].filters[j] = ['in', cat, ...checkedSymbols];
                    //toggle on clear button, if not already
                    if (clear_btn.classList.contains('hide')) {clear_btn.classList.remove('hide')};
                }
                console.log(layers[layer].filters)
                for (type of layer_types){
                    if (layers[layer][type]){
                        map.setFilter(layer.concat('@',type), layers[layer].filters);                  
                    }
                };            
                
            };
            
            map.on('idle',function(){
                console.log('idle')
                if (init_filters) {
                    console.log('through')
                    init_filters = false;
                    for (const layer of Object.keys(layers)){
                        console.log(layers[layer].source_id)

                        const layer_div = document.createElement('div');
                        layer_div.classList.add('dropdown');
                        layer_list.appendChild(layer_div);

                        const toggle_checkbox = document.createElement('input')
                        toggle_checkbox.type = 'checkbox';
                        toggle_checkbox.classList.add('toggle_checkbox');
                        toggle_checkbox.id = layer.concat('@toggle');
                        console.log(layers[layer].visible);
                        if (layers[layer].visible){
                            toggle_checkbox.checked = true;
                        }else {
                            for (type of layer_types){
                                if (layers[layer][type]){
                                    map.setLayoutProperty(layer.concat('@',type), 'visibility', 'none');                 
                                }
                            };
                        };
                        toggle_checkbox.addEventListener("change", function() {
                            const layer_id = this.id.split('@')[0]
                            const legend_div = document.getElementById('legend@'.concat(layer_id));
                            console.log(this.checked)
                            if (!this.checked){
                                for (type of layer_types){
                                    if (layers[layer][type]){
                                        map.setLayoutProperty(layer_id.concat('@',type), 'visibility', 'none');                 
                                    }
                                };
                                if (legend_div){legend_div.classList = 'legend';}
                            } else{
                                for (type of layer_types){
                                    if (layers[layer][type]){
                                        map.setLayoutProperty(layer_id.concat('@',type), 'visibility', 'visible');                 
                                    }
                                };
                                if (legend_div){legend_div.classList = 'legend show';}
                            }
                        });
                        layer_div.appendChild(toggle_checkbox);

                        const layer_button = document.createElement('button');
                        layer_button.classList.add('dropbtn');
                        layer_button.textContent = layers[layer].name;
                        layer_button.addEventListener("click", function() {
                            this.classList.toggle("active");
                            this.nextElementSibling.classList.toggle('show_filters');
                        });
                        layer_div.appendChild(layer_button);

                        const layer_dropdown = document.createElement('div');
                        layer_dropdown.classList.add('filters');
                        layer_div.appendChild(layer_dropdown);

                        layers[layer]['filters'] = ['all']
                        const features = map.querySourceFeatures(layers[layer].source_id, {sourceLayer: layers[layer].source_layer});
                        console.log(features.length)

                        for (const cat of layers[layer].cat_filters){
                            console.log(cat);
                            let vals = [];
                            const val0 = features[0].properties[cat];
                            layers[layer].filters.push(['!=', cat, '!!!']);
                            for (const feature of features) {
                                let val = feature.properties[cat];
                                if (val == null) {val = 'null'};
                                if (!vals.includes(val)) vals.push(val);
                            }

                            //add div,button, dropdown_content, and search input
                            const div = document.createElement('div');
                            div.classList.add('dropdown');
                            layer_dropdown.appendChild(div);

                            const clear = document.createElement('button');
                            clear.classList.add('clearbtn', 'hide');
                            clear.id = layer.concat('@',cat,'@clear');
                            clear.textContent = 'Clear';
                            clear.addEventListener("click", function() {
                                for (checkbox of [...this.parentNode.querySelectorAll('input')].filter((el) => el.checked)) {
                                    checkbox.click();
                                }
                            });
                            div.appendChild(clear);

                            const button = document.createElement('button');
                            button.classList.add('dropbtn', 'gray');
                            button.textContent = cat;
                            button.addEventListener("click", function() {
                                this.classList.toggle("active");
                                this.nextElementSibling.classList.toggle('show');
                            });
                            div.appendChild(button);

                            const dropdown_content = document.createElement('div');
                            dropdown_content.classList.add('dropdown-content');
                            dropdown_content.id = layer.concat('@', cat);
                            div.appendChild(dropdown_content);

                            
                            if (vals.length > 5) {
                                const search = document.createElement('input');
                                search.type = 'text'
                                search.placeholder = 'Search...'
                                search.addEventListener('keyup', function() {
                                    var filter_str, a, i;
                                    filter_str = this.value.toUpperCase();
                                    console.log(filter_str)
                                    a = this.parentElement.getElementsByTagName("label");
                                    for (i = 0; i < a.length; i++) {
                                        txtValue = a[i].textContent || a[i].innerText;
                                        //|| this.parentElement.getElementById(txtValue).checked
                                        if (txtValue.toUpperCase().indexOf(filter_str) == 0 || document.getElementById(this.parentElement.id.concat('@',txtValue)).checked == true) {
                                            a[i].style.display = "";
                                        } else {
                                            a[i].style.display = "none";
                                        }
                                    }
                                });
                                dropdown_content.appendChild(search); 
                            };
                                
                            console.log(vals)
                            for (const val of vals) {
                                const input = document.createElement('input');
                                input.type = 'checkbox';
                                input.id = layer.concat('@',cat,'@',val);
                                input.checked = false;
                                dropdown_content.appendChild(input);
                                
                                const label = document.createElement('label');
                                label.setAttribute('for', layer.concat('@',cat,'@',val));
                                label.textContent = val;
                                dropdown_content.appendChild(label);
                                
                                // When any checkbox changes, update the filter.
                                input.addEventListener('change', updateLayerFilter);
                            };
                        }

                        if (!layers[layer].num_filters) continue;

                        for (const cat of layers[layer].num_filters){
                            console.log(cat);
                            const val0 = features[0].properties[cat];
                            let min = val0;
                            let max = val0;
                            for (const feature of features) {
                                const val = feature.properties[cat];
                                if (val<min) min=val;
                                if (val>max) max=val;
                            }
                            layers[layer].filters.push(['>=', cat, min]);
                            layers[layer].filters.push(['<=', cat, max]);
                            
                            //add div,button, dropdown_content, and search input
                            const div = document.createElement('div');
                            div.classList.add('dropdown');
                            layer_dropdown.appendChild(div);

                            const clear = document.createElement('button');
                            clear.classList.add('clearbtn', 'hide');
                            clear.id = layer.concat('@',cat,'@clear');
                            clear.textContent = 'Clear';
                            
                            clear.addEventListener("click", function() {
                                const splits = this.id.split('@');
                                const cat = splits[1];
                                const layer = splits[0];
                                const j = 1 + layers[layer].cat_filters.length + layers[layer].num_filters.indexOf(cat)*2;
                                this.classList.add('hide');
                                layers[layer].filters[j][2] = min;
                                layers[layer].filters[j+1][2] = max;
                                const fromInput = document.getElementById(layer.concat('@',cat,'@from@input'))
                                fromInput.value = min;
                                document.getElementById(layer.concat('@',cat,'@from@slider')).value = min;
                                const toInput = document.getElementById(layer.concat('@',cat,'@to@input'));
                                toInput.value = max;
                                const toSlider = document.getElementById(layer.concat('@',cat,'@to@slider'));
                                toSlider.value = max;
                                fillSlider(fromInput, toInput, '#C6C6C6', '#128ed6', toSlider);
                                console.log(layers[layer].filters);
                                for (type of layer_types){
                                    if (layers[layer][type]){
                                        map.setFilter(layer.concat('@',type), layers[layer].filters);                  
                                    }
                                };
                            });
                            
                            div.appendChild(clear);

                            const button = document.createElement('button');
                            button.classList.add('dropbtn', 'gray');
                            button.textContent = cat;
                            button.addEventListener("click", function() {
                                this.classList.toggle("active");
                                this.nextElementSibling.classList.toggle('show');
                            });
                            div.appendChild(button);

                            const dropdown_content = document.createElement('div');
                            dropdown_content.classList.add('dropdown-content');
                            dropdown_content.id = layer.concat('@', cat);
                            div.appendChild(dropdown_content);

                            const range_container = document.createElement('div');
                            range_container.classList.add('range_container');
                            dropdown_content.appendChild(range_container); 
                            
                            const slider_div = document.createElement('div');
                            slider_div.classList.add('slider_control');
                            range_container.appendChild(slider_div); 

                            const from_slider = document.createElement('input');
                            from_slider.type = 'range';
                            from_slider.id = layer.concat('@',cat,'@from@slider');
                            from_slider.value = min;
                            from_slider.style.zIndex = 1;
                            from_slider.style.height = 0;
                            from_slider['min'] = min;
                            from_slider['max'] = max;
                            slider_div.appendChild(from_slider); 

                            

                            const to_slider = document.createElement('input');
                            to_slider.type = 'range';
                            to_slider.id = layer.concat('@',cat,'@to@slider');
                            to_slider.value = max;
                            to_slider['min'] = min;
                            to_slider['max'] = max;
                            slider_div.appendChild(to_slider); 

                            const form_control = document.createElement('div');
                            form_control.classList.add('form_control');
                            range_container.appendChild(form_control);

                            const from = document.createElement('input');
                            from.type = 'number';
                            from.id = layer.concat('@',cat,'@from@input');
                            from.value = min;
                            from['min'] = min;
                            from['max'] = max;
                            form_control.appendChild(from); 

                            const to = document.createElement('input');
                            to.type = 'number';
                            to.id = layer.concat('@',cat,'@to@input');
                            to.value = max;
                            to['min'] = min;
                            to['max'] = max;
                            form_control.appendChild(to); 

                            fillSlider(from, to, '#C6C6C6', '#128ed6', to_slider);
                            from_slider.oninput = () => controlFromSlider(from_slider, to_slider, from);
                            to_slider.oninput = () => controlToSlider(from_slider, to_slider, to);
                            from.oninput = () => controlFromInput(from_slider, from, to, to_slider);
                            to.oninput = () => controlToInput(to_slider, from, to, to_slider);

                            from.addEventListener('change', updateNumericFilter);
                            to.addEventListener('change', updateNumericFilter);
                                
                        }
                    }
                }
            });
        });
        
        
    });
</script>

</body>
</html>
<!DOCTYPE html>
<html>
<head>
<meta charset="utf-8">
<script> 
</script>
<title>Map</title>
<meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,minimum-scale=1,user-scalable=no">
<link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet">
<script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
<script src="https://unpkg.com/@turf/turf@6/turf.min.js"></script>
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.js"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-draw/v1.4.3/mapbox-gl-draw.css" type="text/css">
<!-- Load the `mapbox-gl-geocoder` plugin. -->
<script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
<script src="https://kit.fontawesome.com/9a358cbeb3.js" crossorigin="anonymous"></script>
<link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">
<style>
body { margin: 0; padding: 0; }
#map { position: absolute; top: 0; bottom: 0; width: 100%; height: 100%; }

</style>
</head>
<body>
<script>

function updateNumericFilter(target) {
    console.log(target)
    const value = parseFloat(target.value)
    const splits = target.id.split('@');
    const cat = splits[1];
    const layer = splits[0];
    let p = 1;
    if (splits[2] == 'to') p=2;
    let j = Object.keys(layers[layer].num_filters).indexOf(cat)*2 + p;
    if (layers[layer].cat_filters) j = j + Object.keys(layers[layer].cat_filters).length;
    const clear_btn = document.getElementById(layer.concat('@',cat,'@clear'))
    if (clear_btn.classList.contains('hide')) {clear_btn.classList.remove('hide')};
    layers[layer].filters[j][2] = value
    console.log(layers[layer].filters)
    for (type of layer_types){
        if (layers[layer][type]){
            map.setFilter(layer.concat('@',type), layers[layer].filters);                  
        }
    };
}

function controlFromInput(fromSlider, fromInput, toInput, controlSlider) {
    const [from, to] = getParsed(fromInput, toInput);
    fillSlider(fromInput, toInput, '#C6C6C6', '#128ed6', controlSlider);
    if (from > to) {
        fromSlider.value = to;
        fromInput.value = to;
    } else {
        fromSlider.value = from;
    }
    updateNumericFilter(fromInput);
}
    
function controlToInput(toSlider, fromInput, toInput, controlSlider) {
    const [from, to] = getParsed(fromInput, toInput);
    fillSlider(fromInput, toInput, '#C6C6C6', '#128ed6', controlSlider);
    setToggleAccessible(toInput);
    if (from <= to) {
        toSlider.value = to;
        toInput.value = to;
    } else {
        toInput.value = from;
    }
    updateNumericFilter(toInput);
}

function controlFromSlider(fromSlider, toSlider, fromInput) {
  const [from, to] = getParsed(fromSlider, toSlider);
  fillSlider(fromSlider, toSlider, '#C6C6C6', '#128ed6', toSlider);
  if (from > to) {
    fromSlider.value = to;
    fromInput.value = to;
  } else {
    fromInput.value = from;
  }
  updateNumericFilter(fromSlider);
}

function controlToSlider(fromSlider, toSlider, toInput) {
  const [from, to] = getParsed(fromSlider, toSlider);
  fillSlider(fromSlider, toSlider, '#C6C6C6', '#128ed6', toSlider);
  setToggleAccessible(toSlider);
  if (from <= to) {
    toSlider.value = to;
    toInput.value = to;
  } else {
    toInput.value = from;
    toSlider.value = from;
  }
  updateNumericFilter(toSlider);
}

function getParsed(currentFrom, currentTo) {
  const from = parseInt(currentFrom.value, 10);
  const to = parseInt(currentTo.value, 10);
  return [from, to];
}

function fillSlider(from, to, sliderColor, rangeColor, controlSlider) {
    const rangeDistance = to.max-to.min;
    const fromPosition = from.value - to.min;
    const toPosition = to.value - to.min;
    controlSlider.style.background = `linear-gradient(
      to right,
      ${sliderColor} 0%,
      ${sliderColor} ${(fromPosition)/(rangeDistance)*100}%,
      ${rangeColor} ${((fromPosition)/(rangeDistance))*100}%,
      ${rangeColor} ${(toPosition)/(rangeDistance)*100}%, 
      ${sliderColor} ${(toPosition)/(rangeDistance)*100}%, 
      ${sliderColor} 100%)`;
}

function setToggleAccessible(toSlider) {
  if (Number(toSlider.value) <= Number(toSlider.min) ) {
    toSlider.style.zIndex = 2;
  } else {
    toSlider.style.zIndex = 0;
  }
}    
</script>
<style>
.range_container {
    display: flex;
  flex-direction: column;
  width: 90%;
  margin: 10px auto;
}

.slider_control {
  position: relative;
  min-height: 30px;
  padding-top: 10px;
}

.form_control {
  position: relative;
  display: flex;
  justify-content: space-between;
  font-size: 24px;
  color: #635a5a;
}

input[type=range]::-webkit-slider-thumb {
  -webkit-appearance: none;
  pointer-events: all;
  width: 12px;
  height: 12px;
  background-color: #fff;
  border-radius: 50%;
  box-shadow: 0 0 0 1px #C6C6C6;
  cursor: pointer;
}

input[type=range]::-moz-range-thumb {
  -webkit-appearance: none;
  appearance: none;
  pointer-events: all;
  width: 12px;
  height: 12px;
  background-color: #fff;
  border-radius: 50%;
  box-shadow: 0 0 0 1px #C6C6C6;
  cursor: pointer;  
}

input[type=range]::-webkit-slider-thumb:hover {
  background: #f7f7f7;
}

input[type=range]::-webkit-slider-thumb:active {
  box-shadow: inset 0 0 3px #387bbe, 0 0 9px #387bbe;
  -webkit-box-shadow: inset 0 0 3px #387bbe, 0 0 9px #387bbe;
}

input[type="number"] {
  color: #8a8383;
  height: 30px;
  width: 100px;
  font-size: 20px;
  border: none;
}

input[type=number]::-webkit-inner-spin-button, 
input[type=number]::-webkit-outer-spin-button {  
   opacity: 1;
}

input[type="range"] {
  -webkit-appearance: none; 
  appearance: none;
  height: 2px;
  width: 100%;
  position: relative;
  background-color: #C6C6C6;
  pointer-events: none;
}


</style>
<script>
const bounds_dict = {
    "test":{
        "bounds":[[-85.43912683641372, 33.26118181948529], [-82.06632411429437, 34.456279633297356]],
        "geocoder_bounds":[-85.84562097556167, 30.177882355149897, -80.16568935557564, 35.267583145126984],
        "url": 'https://wodacooper.github.io/mapbox/us_test.json'
    },
    "az":{
        "bounds":[[-112.85213370466587, 32.55524609368921], [-110.58895036953413, 34.01542804220637]],
        "geocoder_bounds":[-115.28142166744192, 31.724851547973447, -108.7395412009782, 37.26979298744543],
        "url": 'https://wodacooper.github.io/mapbox/az_layers.json'
    },
    "fl":{
        "bounds":[[-84.37526158463271, 26.255905741318735], [-78.81301050869402, 29.55055750061163]],
        "geocoder_bounds":[-88.71461624270614, 23.921499535069774, -79.13453815251694, 30.93568899111583],
        "url": 'https://wodacooper.github.io/mapbox/fl_layers.json'
    },
    "ga":{
        "bounds":[[-85.43912683641372, 33.26118181948529], [-82.06632411429437, 34.456279633297356]],
        "geocoder_bounds":[-85.84562097556167, 30.177882355149897, -80.16568935557564, 35.267583145126984],
        "url": 'https://wodacooper.github.io/mapbox/ga_layers.json'
    },
    "ia":{
        "bounds":[[-96.58859136144741, 40.343619780357525], [-89.95865987289943, 43.564125073484746]],
        "geocoder_bounds":[-96.58859136144741, 40.343619780357525, -89.95865987289943, 43.564125073484746],
        "url": 'https://wodacooper.github.io/mapbox/ia_layers.json'
    },
    "il":{
        "bounds":[[-92.33696195567066, 39.418647809974566], [-86.21191743849026, 42.50919789328073]],
        "geocoder_bounds":[-91.63330148894498, 36.904239278804766, -86.85160877187725, 42.709289768656845],
        "url": 'https://wodacooper.github.io/mapbox/il_layers.json'
    },
    "in":{
        "bounds":[[-88.179790, 37.727327], [-84.704993, 41.822297]],
        "geocoder_bounds":[-88.179790, 37.727327, -84.704993, 41.822297],
        "url": 'https://wodacooper.github.io/mapbox/in_layers.json'
    },
    "ky":{
        "bounds":[[-86.29441748259278, 37.535686404222595], [-83.15232765026008, 39.35961014228036]],
        "geocoder_bounds":[-89.79389490859442, 36.41331788111147, -81.57612150095505, 39.15646674651189],
        "url": 'https://wodacooper.github.io/mapbox/ky_layers.json'
    },
    "md":{
        "bounds":[[-77.40591238347997, 38.87473399727833], [-76.2231571782379, 39.43496350972831]],
        "geocoder_bounds":[-79.6603182359571, 37.7528949706738, -75.02958094809614, 39.80809971869814],
        "url": 'https://wodacooper.github.io/mapbox/md_layers.json'
    },
    "mi":{
        "bounds":[[-86.90464804275261, 41.621276181568945], [-81.74040262067126, 44.072706594990784]],
        "geocoder_bounds":[-91.6000050692998, 41.499222990135976, -80.72354026507124, 48.508329766238695],
        "url": 'https://wodacooper.github.io/mapbox/mi_layers.json'
    },
    "mn":{
        "bounds":[[-94.03085731819222, 44.59957784376794], [-92.63559365038905, 45.2896862973992]],
        "geocoder_bounds":[-97.47317460324436, 43.15312378811857, -89.30070514530094, 49.27213785125212],
        "url": 'https://wodacooper.github.io/mapbox/mn_layers.json'
    },
    "nc":{
        "bounds":[[-85.06946472835623, 33.76174643768254], [-75.2145182382345, 36.62398238765238]],
        "geocoder_bounds":[-85.06946472835623, 33.76174643768254, -75.2145182382345, 36.62398238765238],
        "url": 'https://wodacooper.github.io/mapbox/nc_layers.json'
    },
    "oh":{
        "bounds":[[-84.83129871846774, 38.923507292003464], [-80.13127384058429, 41.82213923170013]],
        "geocoder_bounds":[-84.9920112412373, 38.13631316512096, -79.61938750293479, 42.666516193569436],
        "url": 'https://wodacooper.github.io/mapbox/oh_layers.json'
    },
    "pa":{
        "bounds":[[-80.9001017853645, 39.573387273853], [-74.2338017386523, 42.4821662783562873]],
        "geocoder_bounds":[-80.9001017853645, 39.573387273853, -74.2338017386523, 42.4821662783562873],
        "url": 'https://wodacooper.github.io/mapbox/pa_layers.json'
    },
    "sc":{
        "bounds":[[-81.99646042127142, 32.98598312860454], [-79.21571288630456, 34.52971849799379]],
        "geocoder_bounds":[-83.71394014665334, 32.07074914501098, -78.36143876212576, 35.301973670057464],
        "url": 'https://wodacooper.github.io/mapbox/sc_layers.json'
    },
    "tn":{
        "bounds":[[-90.3825280445324, 34.96887740860476], [-81.6010795602466, 36.669837673931525]],
        "geocoder_bounds":[-90.3825280445324, 34.96887740860476, -81.6010795602466, 36.669837673931525],
        "url": 'https://wodacooper.github.io/mapbox/tn_layers.json'
    },
    "tx":{
        "bounds":[[-104.67600379049759, 29.299826272128293], [-93.48935358190582, 35.05542384021815]],
        "geocoder_bounds":[-107.22683640991858, 25.657179541914736, -92.39529349506144, 36.558898240440655],
        "url": 'https://wodacooper.github.io/mapbox/tx_layers.json'
    },
    "va":{
        "bounds":[[-78.90103164743579, 36.619605614978745], [-75.18061674186872, 38.16481642066047]],
        "geocoder_bounds":[-83.80881301222638, 36.55604636006495, -75.53117255363946, 39.625717232985615],
        "url": 'https://wodacooper.github.io/mapbox/va_layers.json'
    },
    "wi":{
        "bounds":[[-91.81516202544215, 42.4824468835611], [-86.99871447323014, 44.7495387545328]],
        "geocoder_bounds":[-93.08914727732419, 42.41904924359892, -86.19111432679766, 47.426598853498625],
        "url": 'https://wodacooper.github.io/mapbox/wi_layers.json'
    },
    "wv":{
        "bounds":[[-82.96804854706158, 37.08701648003831], [-77.31429927306313, 41.03426453486921]],
        "geocoder_bounds":[-82.96804854706158, 37.08701648003831, -77.31429927306313, 41.03426453486921],
        "url": 'https://wodacooper.github.io/mapbox/wv_layers.json'
    },
"qct":{
        "bounds":[[-102.3730577149232, 30.749061535513654], [-73.03945321153677, 43.16674390102708]],
        "geocoder_bounds":[-107.30772781365022, 25.299889658938284, -72.28951798383322, 49.75322339114976],
        "url": 'https://wodacooper.github.io/mapbox/qct_layers.json'
    }
}
</script>
<style>


    .dropbtn {
        background-color: #128ed6;
        color: white;
        padding: 10px;
        width:220px;
        border: none;
        font-size: 16px;
        
        cursor: pointer;
    }

    .clearbtn {
        background-color: #ddd;
        color: #128ed6;
        padding: 4px;
        font-size: 10px;
        position:absolute;
        right: 5px;
        top: 17px;
        border: none;
        border: 1px solid #ddd;
        cursor: pointer;
    }

    .dropdown-content input[type='text'] {
        box-sizing: border-box;
        background-position: 14px 12px;
        background-repeat: no-repeat;
        font-size: 16px;
        padding: 10px 0px 10px 10px;
        border: none;
        border-bottom: 1px solid #ddd;
    }

    .dropdown-content input[type='text']:focus {outline: 3px solid #ddd;}

    .dropdown {
        position: relative;
        display: block;
        width:220px;
    }
    .filters {
        position: relative;
        display: block;
        width:220px;
        display: none;
        max-height: 0px;
    }

    .toggle_checkbox{
        position:absolute;
        right: 5px;
        top: 8px;
        cursor: pointer;
    }
    .dropdown_arrow{
        position:absolute;
        left: 10px;
        top: 8px;
        color:#fff;
    }
    .dropdown_btn{
        position: relative;
        left: 0px;
        top: 0px;
        color: #000000;
    }

    .dropdown-content {
        overflow-y: auto;
        border: 1px solid #ddd;
        width:220px;
        max-height: 0px;
        background-color: #fff;
    }

    .dropdown-content input[type='checkbox'] {
        display: none;
    }
    
    .dropdown-content input[type='checkbox'] + label {
        background-color: #fff;
        display: block;
        cursor: pointer;
        padding: 10px;
        border-bottom: 1px solid rgba(0, 0, 0, 0.25);
    }

    .dropdown-content input[type='checkbox'] + label:hover,
    .dropdown-content input[type='checkbox']:checked + label {
        background-color: #fff;
    }
    
    .dropdown-content input[type='checkbox']:checked + label:before {
        content: 'âœ”';
        margin-right: 5px;
    }
    @media (max-width:600px){
        .dropbtn{
            font-size: 14px;
            padding: 8px;
        }
    }

    .dropdown a:hover {background-color: #ddd;}


    .box {
        float: left;
        height: 20px;
        width: 20px;
        margin-bottom: 15px;
        border: 1px solid black;
        clear: both;
    }
    .legend-box{
        max-height: 450px;
        position:absolute;
        right: 10px;
        bottom: 20px;
        padding: 10px;
        font-size:12px;
        overflow-y: auto;
    }
    .legend-list li{
        display: flex;
        align-items: center;
    }
    .legend-list span{
        display:inline-block;
        width: 20px;
        height: 20px;
    }
    .legend_btn{
        position: relative;
        left: 0px;
        top: 0px;
        color: #000000;
    }

    @media only screen and(max-width:600px) {
        .legend-box{
            font-size: 10px;
        }
        
    }
    .legend {
        overflow-wrap: anywhere;
        display: none;
        padding: 12px;
        border: 1px solid #ddd;
        max-height: 0px;
        background-color: rgba(255, 255, 255, 0.9);
        font-weight: bold;
    }

    .legend-list { list-style-type: none; margin: 0; padding: 0px;}
    .legend-list li {padding: 0px; font-weight: normal; }
    .legend-list span { border: 1px solid #000000; float: left; width: 12px; height: 12px; margin: 2px; }

    .popup-box {
        max-width: 300px;
        max-height: 300px;
        overflow-y: auto;
    }

    .popup-box p {
        margin: 0;
        padding: 0 0 5px;
    }

    .popup-box h3 {
        margin: 0;
        padding: 0 0 5px;
    }

    .popup-box h4 {
        margin: 0;
        padding: 0;
        color: #aaaaaa    
    }
    .mapboxgl-ctrl-geocoder {
        min-width: 300px;
        max-width: 400px;
    }
    @media (max-width:600px) {
        .mapboxgl-ctrl-geocoder{
            min-width: 100px;
            max-width: 250px; 
        } 
    }

    .mapboxgl-ctrl-top-right .mapboxgl-ctrl-group{
        display: flex;
        flex-direction: row;
    }
    
    .popup {
        display: none;
        position: absolute;
        width: 100px;
        background-color: white;
        padding: 10px;
        bottom: 95px;
        left: 20px;
    }
    .googlemaps_link {
        font-size: 15px;
        text-align: right;
        cursor: pointer;
        color: white;
        pointer-events: auto;
        background: #128ed6;
        margin: 4px 0 0 0;
        padding: 6px 10px;
        border-radius: 4px;
        width: 100px;
        box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .googlemaps_link:hover {
        width: 120px;
        background: #45b9fc;
        font-size: 16px;
        font-weight: bold;
        box-shadow:
            -8px 0 18px -8px #0a5c8c55, 
            0 4px 12px rgba(0,0,0,0.18);
    }
    
    .mapboxgl-ctrl-top-right {
        display: flex;
        flex-direction: column;
        align-items: flex-end;
    }
    .mapboxgl-ctrl-top-right .mapboxgl-ctrl-group {
        margin-bottom: 8px;
    }
    .area{
        position: absolute;
        width: 100px;
        background-color: white;
        bottom: 95px;
        left: 150px;
    }
    .mapboxgl-popup-content h3{
        padding-right: 15px;
    }
    .mapboxgl-popup-close-button{
        position: sticky;
        bottom: 90%;
        left: 90%;
        padding: 0%;
        font-size: 17px;
    }
    .mapboxgl-ctrl-attrib.mapboxgl-compact {
        width:80px;
        margin: 0;

    }

    a.mapboxgl-ctrl-logo {
        height: 23px;
        width: 80px;
        margin: 0 0 -3px 2px;
        }

    .show {display: block; max-height: 250px;}

    .show input[type='range'] {position: absolute;}
    .show_filters {display: block;max-height: 800px;}
    .hide {display: none;}

    .gray {background-color: #aaaaaa;}

    .legend-box {
        padding: 0px;
        right: 0px;
        bottom: 24px;

    }

</style>
<div id="map"></div>
<div id="layer_box"></div>
<div id="legend_box" class = "legend-box"></div>
<div id="popup_box" class="popup">
    <div class="popup_content" id ="popup-caption">Radius</div>
    <input type="number" step="0.01" id="popup_content" value="1" />
    <div class="color_caption" id ="color-caption">Color</div>
    <input type="color" id="color-picker"/> 
</div>
<div id="area_box" class="area"></div>
<script>
    
    
    //const query_string = 'https://wodacooper.github.io/mapbox/mapbox.html?pk.eyJ1Ijoid29kYWNvb3BlciIsImEiOiJjbThxZHpqbWUwa3EyMmlwd2I2Y3pxaHhpIn0.AXMTVNv_2fzrerGtEvAhxA?mn'
    const query_string = window.location.search;
    
    const query_vals = query_string.split('?')

    //const query_vals = ['', 'pk.eyJ1Ijoid29kYWNvb3BlciIsImEiOiJjbHQ4dTBwdmIwYmE5MmtsY2pndGtrbDcxIn0.ZymqiloBBqzGMcNlqdo4bA', 'oh']
    
    mapboxgl.accessToken = query_vals[1];
    const map = new mapboxgl.Map({
        container: 'map',
        // Choose from Mapbox's core styles, or make your own style with Mapbox Studio
        style: 'mapbox://styles/mapbox/satellite-streets-v12',
        bounds: bounds_dict[query_vals[2]]["bounds"],
        attributionControl: false
    }).addControl(new mapboxgl.AttributionControl({
        compact: true
    }));
    /*const geocoder_bounds = bounds_dict[query_vals[2]]["geocoder_bounds"]
    async function get_json() {
            const query = await fetch(
                'https://wodacooper.github.io/mapbox/VA_testlayers.json',
                { method: 'GET' }
            );
            const data = await query.json();
            console.log(data);
            return data;
    }*/
    const geocoder_bounds = bounds_dict[query_vals[2]]["geocoder_bounds"]
    async function get_json() {
            const query = await fetch(
                bounds_dict[query_vals[2]]["url"],
                { method: 'GET' }
            );
            const data = await query.json();
            console.log(data);
            return data;
    }
    document.addEventListener('DOMContentLoaded',()=>{
        var colorPicker =document.getElementById('color-picker');
        colorPicker.value ='#ffffff';
    });

    const layer_box = document.getElementById('layer_box');
    const legend_box = document.getElementById('legend_box');


    var allow_click = true;
    var circle_mode = false;
    var drive_mode = false;
    var walk_mode = false;
    var init_filters = true;
    const layer_types = ['fill','circle','icon','line']
    var hover_layers = [];
    var click_layers = [];
    var layers;
    

    map.on('load', () => {
        get_json().then(data => {
            layers = data;
            var sources = []
            
            //Dropdown button for the layerlist box in the top left
            const dropdown_btn = document.createElement('button');
            dropdown_btn.classList.add('fa-solid','fa-caret-up','dropdown_btn');
            dropdown_btn.addEventListener('click',() =>{
                if(layer_list.style.display == 'none'){
                    layer_list.style.display='block';
                    dropdown_btn.classList.remove('fa-solid','fa-caret-down','dropdown_btn') 
                    dropdown_btn.classList.add('fa-solid','fa-caret-up','dropdown_btn')
                    
                
                }else{
                    layer_list.style.display='none';
                    dropdown_btn.classList.remove('fa-solid','fa-caret-up','dropdown_btn') 
                    dropdown_btn.classList.add('fa-solid','fa-caret-down','dropdown_btn')
                }
            });
            
            const layer_list = document.createElement('div');
            layer_box.appendChild(layer_list);

            layer_box.appendChild(dropdown_btn);

            //Dropdown button for the legend box in the bottom right
            const legend_btn = document.createElement('button');
            legend_btn.classList.add('fa-solid','fa-caret-down','legend_btn');
            legend_btn.addEventListener('click',() =>{
                if(legend_inner.style.display == 'none'){
                    legend_inner.style.display='block';
                    legend_btn.classList.remove('fa-solid','fa-caret-up','dropdown_btn') 
                    legend_btn.classList.add('fa-solid','fa-caret-down','dropdown_btn')
                    
                }else{
                    legend_inner.style.display ='none';
                    legend_btn.classList.remove('fa-solid','fa-caret-down','dropdown_btn') 
                    legend_btn.classList.add('fa-solid','fa-caret-up','dropdown_btn')
                }
            });
            legend_box.appendChild(legend_btn);
            
            const legend_inner = document.createElement('div');
            legend_box.appendChild(legend_inner);
            
            for (const layer of Object.keys(layers).reverse()){
                //if source has already been added for another layer, no need to add again
                if (map.getSource(layers[layer].source_id) == undefined){
                    map.addSource(layers[layer].source_id, {
                        type: 'vector',
                        url: layers[layer].url
                    });
                }
                
                for (type of layer_types){
                    if (layers[layer][type]){
                        map.addLayer(
                            {
                                'id': layer.concat('@',type),
                                'type': type,
                                'source': layers[layer].source_id,
                                'source-layer': layers[layer].source_layer,
                                'layout': layers[layer].layout,
                                'paint': layers[layer][type]
                            }
                        );                   
                    }
                };

                if (layers[layer].hover) {
                    for (type of layer_types){
                        if (layers[layer][type]){
                            hover_layers.push(layer.concat('@',type));
                            break;        
                        }
                    };
                };

                if (layers[layer].click) {
                    for (type of layer_types){
                        if (layers[layer][type]){
                            click_layers.push(layer.concat('@',type));
                            break;        
                        }
                    };
                };

                
                const leg_dict = layers[layer].legend;
                if (leg_dict){
                    console.log(leg_dict)
                    const legend_div = document.createElement('div');
                    legend_div.id = 'legend@'.concat(layer)
                    legend_div.classList.add('legend');
                    if (layers[layer].visible){legend_div.classList.add('show');};
                    legend_div.innerText = layers[layer].name;
                    legend_inner.appendChild(legend_div);

                    const legend = document.createElement('ul');
                    legend.classList.add('legend-list');
                    legend_div.appendChild(legend);
                    for (const pair of leg_dict){
                        const row = document.createElement('li');
                        row. innerHTML = `<span style="background-color:${pair[1]}"></span> &nbsp;${pair[0]}`;
                        legend.appendChild(row);
                    };
                };
            };
        
            const coordinatesGeocoder = function (query)  {
                const matches = query.match(/^[ ]*(?:Lat: )?(-?\d+\.?\d*)[, ]+(?:Lng: )?(-?\d+\.?\d*)[ ]*$/i);
                if (!matches) {
                    return null;
                }
                const lat = Number(matches[1]);
                const lng = Number(matches[2]);
                const geocodes = {
                    center: [lng, lat],
                    geometry: {
                        type: 'Point',
                        coordinates: [lng, lat]
                    },
                    place_name: lat + ', ' + lng,
                    place_type: ['coordinate'],
                    properties: {},
                    type: 'Feature'
                };
                return [geocodes];
            }

            map.addControl(
                new MapboxGeocoder({
                    accessToken: mapboxgl.accessToken,
                    bbox: geocoder_bounds,
                    localGeocoder: coordinatesGeocoder,
                    mapboxgl: mapboxgl
                })
            );

            var draw_circlemode ={};
            draw_circlemode.onClick = function(state, e) {
                const feature = turf.circle([e.lngLat.lng, e.lngLat.lat], popupContent.value, {units:'miles'});
                console.log(feature);
                feature.properties = { color: colorPicker.value };
                const id = draw.add(feature);
                console.log(draw.getAll());
                this.changeMode('simple_select');
                popup.style.display = 'none';
            
            };
            var draw_drivemode ={};
            draw_drivemode.onClick = function(state, e){   
                getIso('driving',e);
                this.changeMode('simple_select');
                popup.style.display = 'none';
            };
            var draw_walkmode ={};
            draw_walkmode.onClick = function(state, e){   
                getIso('walking',e);
                this.changeMode('simple_select');
                popup.style.display = 'none';
            };

            const draw = new MapboxDraw({
                modes: Object.assign({
                    draw_circle: draw_circlemode,
                    draw_drive: draw_drivemode,
                    draw_walk: draw_walkmode,
                }, MapboxDraw.modes),
                displayControlsDefault: false,
                userProperties: true,
                styles: [
                    {
                        'id': 'gl-draw-polygon-fill-inactive',
                        'type': 'fill',
                        'filter': ['all',
                        ['==', 'active', 'false'],
                        ['==', '$type', 'Polygon'],
                        ['!=', 'mode', 'static']
                        ],
                        'paint': {
                        'fill-color': ['get','user_color'],
                        'fill-outline-color': ['get','user_color'],
                        'fill-opacity': 0.1
                        }
                    },
                    {
                        'id': 'gl-draw-polygon-fill-active',
                        'type': 'fill',
                        'filter': ['all', ['==', 'active', 'true'], ['==', '$type', 'Polygon']],
                        'paint': {
                        'fill-color': '#fbb03b',
                        'fill-outline-color': '#ffffff',
                        'fill-opacity': 0.1
                        }
                    },
                    {
                        'id': 'gl-draw-polygon-midpoint',
                        'type': 'circle',
                        'filter': ['all',
                        ['==', '$type', 'Point'],
                        ['==', 'meta', 'midpoint']],
                        'paint': {
                        'circle-radius': 3,
                        'circle-color': '#fbb03b'
                        }
                    },
                    {
                        'id': 'gl-draw-polygon-stroke-inactive',
                        'type': 'line',
                        'filter': ['all',
                        ['==', 'active', 'false'],
                        ['==', '$type', 'Polygon'],
                        ['!=', 'mode', 'static']
                        ],
                        'layout': {
                        'line-cap': 'round',
                        'line-join': 'round'
                        },
                        'paint': {
                        'line-color': ['get','user_color'],
                        'line-width': 2
                        }
                    },
                    {
                        'id': 'gl-draw-polygon-stroke-active',
                        'type': 'line',
                        'filter': ['all', ['==', 'active', 'true'], ['==', '$type', 'Polygon']],
                        'layout': {
                        'line-cap': 'round',
                        'line-join': 'round'
                        },
                        'paint': {
                        'line-color': '#ffffff',
                        'line-dasharray': [0.2, 2],
                        'line-width': 2
                        }
                    },
                    {
                        'id': 'gl-draw-line-inactive',
                        'type': 'line',
                        'filter': ['all',
                        ['==', 'active', 'false'],
                        ['==', '$type', 'LineString'],
                        ['!=', 'mode', 'static']
                        ],
                        'layout': {
                        'line-cap': 'round',
                        'line-join': 'round'
                        },
                        'paint': {
                        'line-color': ['get','user_color'],
                        'line-width': 2
                        }
                    },
                    {
                        'id': 'gl-draw-line-active',
                        'type': 'line',
                        'filter': ['all',
                        ['==', '$type', 'LineString'],
                        ['==', 'active', 'true']
                        ],
                        'layout': {
                        'line-cap': 'round',
                        'line-join': 'round'
                        },
                        'paint': {
                        'line-color': '#ffffff',
                        'line-dasharray': [0.2, 2],
                        'line-width': 2
                        }
                    },
                    {
                        'id': 'gl-draw-polygon-and-line-vertex-stroke-inactive',
                        'type': 'circle',
                        'filter': ['all',
                        ['==', 'meta', 'vertex'],
                        ['==', '$type', 'Point'],
                        ['!=', 'mode', 'static']
                        ],
                        'paint': {
                        'circle-radius': 5,
                        'circle-color': '#ffffff'
                        }
                    },
                    {
                        'id': 'gl-draw-polygon-and-line-vertex-inactive',
                        'type': 'circle',
                        'filter': ['all',
                        ['==', 'meta', 'vertex'],
                        ['==', '$type', 'Point'],
                        ['!=', 'mode', 'static']
                        ],
                        'paint': {
                        'circle-radius': 3,
                        'circle-color': '#ffffff'
                        }
                    },
                    {
                        'id': 'gl-draw-point-point-stroke-inactive',
                        'type': 'circle',
                        'filter': ['all',
                        ['==', 'active', 'false'],
                        ['==', '$type', 'Point'],
                        ['==', 'meta', 'feature'],
                        ['!=', 'mode', 'static']
                        ],
                        'paint': {
                        'circle-radius': 5,
                        'circle-opacity': 1,
                        'circle-color': '#ffffff'
                        }
                    },
                    {
                        'id': 'gl-draw-point-inactive',
                        'type': 'circle',
                        'filter': ['all',
                        ['==', 'active', 'false'],
                        ['==', '$type', 'Point'],
                        ['==', 'meta', 'feature'],
                        ['!=', 'mode', 'static']
                        ],
                        'paint': {
                        'circle-radius': 3,
                        'circle-color': '#ffffff'
                        }
                    },
                    {
                        'id': 'gl-draw-point-stroke-active',
                        'type': 'circle',
                        'filter': ['all',
                        ['==', '$type', 'Point'],
                        ['==', 'active', 'true'],
                        ['!=', 'meta', 'midpoint']
                        ],
                        'paint': {
                        'circle-radius': 7,
                        'circle-color': '#ffffff'
                        }
                    },
                    {
                        'id': 'gl-draw-point-active',
                        'type': 'circle',
                        'filter': ['all',
                        ['==', '$type', 'Point'],
                        ['!=', 'meta', 'midpoint'],
                        ['==', 'active', 'true']],
                        'paint': {
                        'circle-radius': 5,
                        'circle-color': '#ffffff'
                        }
                    },
                    {
                        'id': 'gl-draw-polygon-fill-static',
                        'type': 'fill',
                        'filter': ['all', ['==', 'mode', 'static'], ['==', '$type', 'Polygon']],
                        'paint': {
                        'fill-color': ['get','user_color'],
                        'fill-outline-color': ['get','user_color'],
                        'fill-opacity': 0.1
                        }
                    },
                    {
                        'id': 'gl-draw-polygon-stroke-static',
                        'type': 'line',
                        'filter': ['all', ['==', 'mode', 'static'], ['==', '$type', 'Polygon']],
                        'layout': {
                        'line-cap': 'round',
                        'line-join': 'round'
                        },
                        'paint': {
                        'line-color': ['get','user_color'],
                        'line-width': 2
                        }
                    },
                    {
                        'id': 'gl-draw-line-static',
                        'type': 'line',
                        'filter': ['all', ['==', 'mode', 'static'], ['==', '$type', 'LineString']],
                        'layout': {
                        'line-cap': 'round',
                        'line-join': 'round'
                        },
                        'paint': {
                        'line-color': ['get','user_color'],
                        'line-width': 2
                        }
                    },
                    {
                        'id': 'gl-draw-point-static',
                        'type': 'circle',
                        'filter': ['all', ['==', 'mode', 'static'], ['==', '$type', 'Point']],
                        'paint': {
                        'circle-radius': 5,
                        'circle-color': ['get','user_color']
                        }
                    }
                ],
                // Select which mapbox-gl-draw control buttons to add to the map.
                controls: {
                polygon: true,
                line_string: true,
                point: true,
                trash: true,
                },
                // Set mapbox-gl-draw to draw by default.
                // The user does not have to click the polygon control button first.
                //defaultMode: 'draw_polygon'
            });
            
            map.addControl(draw, 'top-right');

            map.addControl(
                new mapboxgl.NavigationControl({
                    showCompass: false
                })
            );

            //Code for linking Google maps to mapbox
            var googleMaps_link = document.createElement('div');
            googleMaps_link.className = 'googlemaps_link';
            googleMaps_link.textContent = 'Google Maps';

            var logo = document.querySelector('.mapboxgl-ctrl-top-right');

        
            googleMaps_link.addEventListener('click', () => {
                var center = map.getCenter();
                var zoom = 2+Math.round(map.getZoom());
                var googleMapsUrl = `https://www.google.com/maps/@?api=1&map_action=map&center=${center.lat}%2C${center.lng}&zoom=${zoom}&basemap=satellite&layer=transit`;
                console.log(googleMapsUrl);
                window.open(googleMapsUrl,'_blank');
            });
            
            var flood_link = document.createElement('div');
            flood_link.className = 'googlemaps_link';
            flood_link.textContent = 'NEPAAssist';

            var logo = document.querySelector('.mapboxgl-ctrl-top-right');


            flood_link.addEventListener('click', () => {
                var center = map.getCenter();
                var floodMapsUrl = `https://nepassisttool.epa.gov/nepassist/nepamap.aspx?wherestr=${center.lat}%2C%20${center.lng}`;
                console.log(floodMapsUrl);
                window.open(floodMapsUrl,'_blank');
            });

            var ctrlGroups = document.querySelectorAll('.mapboxgl-ctrl-top-right .mapboxgl-ctrl-group');
            var navCtrl = ctrlGroups[ctrlGroups.length - 1];

            navCtrl.insertAdjacentElement('afterend', flood_link);
            flood_link.style.display = 'block';
            navCtrl.insertAdjacentElement('afterend', googleMaps_link);
            googleMaps_link.style.display = 'block';

            const mapboxLogo = document.getElementsByClassName('mapboxgl-ctrl-logo')[0];
            console.log(mapboxLogo);
            const cloneLogo = mapboxLogo.cloneNode(true);
            const bottomRight = document.getElementsByClassName('mapboxgl-ctrl-bottom-right')[0].children[0];
            mapboxLogo.remove();
            
            bottomRight.appendChild(cloneLogo);

            const controls = document.getElementsByClassName('mapboxgl-ctrl-top-right')[0].children[1];
            const popup = document.getElementById('popup_box');
            const popupContent = document.getElementById('popup_content');
            const colorPicker = document.getElementById('color-picker');
            const areaBox = document.getElementById('area_box');
            
            const delete_btn = document.getElementsByClassName('mapbox-gl-draw_trash')[0]
            delete_btn.classList.remove('mapbox-gl-draw_trash', 'mapbox-gl-draw_ctrl-draw-btn')
            delete_btn.classList.add('fa-solid', 'fa-delete-left');
          
            const trash_btn = document.createElement('button');
            trash_btn.classList.add('fa-solid', 'fa-trash-can');
            //delete_btn.innerText = "X";
            trash_btn .addEventListener('click', () => {
                draw.deleteAll();
                document.getElementById('area_box').style.display = 'none';
            });
            controls.appendChild(trash_btn);

            const circle_btn = document.createElement('button');
            circle_btn.classList.add('fa-regular', 'fa-circle');
            circle_btn .addEventListener('click', () => {
                allow_click = false;
                draw.changeMode('draw_circle')
                popup.style.display = 'block';
            });
            controls.prepend(circle_btn);
            
            const drive_btn = document.createElement('button');
            drive_btn.classList.add('fa-solid', 'fa-car');
            drive_btn .addEventListener('click', () => {
                allow_click = false;
                draw.changeMode('draw_drive')
                popup.style.display = 'block';
            });
            controls.prepend(drive_btn);

            const walk_btn = document.createElement('button');
            walk_btn.classList.add('fa-solid', 'fa-person-walking');
            walk_btn .addEventListener('click', () => {
                allow_click = false;
                draw.changeMode('draw_walk')
                popup.style.display = 'block';
            });
            controls.prepend(walk_btn);

            async function getIso(mode,e) {
                
                const query = await fetch(
                    `https://api.mapbox.com/isochrone/v1/mapbox/${mode}/${e.lngLat.lng},${e.lngLat.lat}?contours_meters=${String(Math.round(popupContent.value*1609))}&polygons=true&access_token=${mapboxgl.accessToken}`,
                    { method: 'GET' }
                );
                
                const data = await query.json();
                const feat=data.features[0];
                console.log(feat)
                feat.properties = { color: colorPicker.value };
                draw.add(feat)
            }
        
            
            map.on('draw.create', updateColor);
            function updateColor(e) {
                const data = draw.getAll();
                const num_features = data.features.length
                const feature = data.features[num_features-1].id;
                draw.setFeatureProperty(feature,'color', colorPicker.value);
                popup.style.display = 'none';
                console.log('bing_bong')
                console.log(feature)
            };
            //Code for having the popup appear for each mode
            map.on('draw.modechange', () => {
                const mode = draw.getMode()
                const color_modes = ['draw_walk', 'draw_drive','draw_circle','draw_line_string','draw_point', 'draw_polygon']
                if (color_modes.includes(mode)) {
                    popup.style.display = 'block';
                } else {
                    popup.style.display = 'none'
                }
            });

             //map.on('click', getIso);
            

            map.on('draw.create', updateArea);
            map.on('draw.delete', updateArea);
            map.on('draw.update', updateArea)
        
            //Displaying the distance and area for the line and polygon tools
            function updateArea(e) {
                const data = draw.getAll();
                const answer = document.getElementById('area_box');
                const num_features = data.features.length
                if (num_features > 0) {
                    const feature = data.features[num_features-1].geometry;
                    if (feature.type == 'Polygon') {
                        const area = turf.area(feature);
                        const acres = Math.round(area/4046.86 * 100) / 100;
                        const square_feet = Math.round(area*10.793);
                        if(acres < 1000000){
                            answer.innerHTML= `${acres} acres <br> ${square_feet.toLocaleString()} sq ft`;
                        }else{
                            answer.innerHTML = `${acres} acres`;
                        }
                        areaBox.style.display = 'block';

                    } else if(feature.type == 'LineString')  {
                        const length_miles = Math.round(turf.length(feature,{units:'miles'})* 100) / 100;
                        const length_feet = Math.round(length_miles*5280);
                        if(length_miles < 1){
                            answer.innerHTML = `${length_miles} miles <br> ${length_feet.toLocaleString()} feet`;
                        }
                        else{
                            answer.innerHTML = `${length_miles} miles`;
                        }
                        areaBox.style.display = 'block';
                    }
              
                 }
            }
            

            const tooltip = new mapboxgl.Popup({anchor: 'top-left', closeOnClick: false, closeButton: false}).trackPointer()
                        
            tooltip.addTo(map)


            
            map.on('mouseleave', hover_layers, (e) => {
                tooltip.remove()
            });
        
            map.on('mousemove', hover_layers, (e) => {
                let table = ['<div style="line-height: 100%">']
                for (layer_name of hover_layers) {
                    layer = layer_name.split('@')[0];
                    if (map.getLayoutProperty(layer_name, 'visibility') == 'visible'){
                        feature = map.queryRenderedFeatures(e.point, {layers: [layer_name]})[0]
                        if (feature) {
                            table.push(`<h3 style="margin:0; padding:0 0 5px">${layers[layer].name}</h3>`)
                            const hover_cats = layers[layer]['hover'];
                            for (let [key, args] of Object.entries(hover_cats)){
                                let value = feature.properties[key];
                                if (value||value == 0){
                                    if(args[0]){
                                            if(args[1]==""){
                                                    table.push(`<h4 style="margin:0; padding:0;color: #aaaaaa;">${key}</h4>`);
                                                } else{
                                                    table.push(`<h4 style="margin:0; padding:0;color: #aaaaaa;">${args[1]}</h4>`);
                                                }
                                            }
                                    table.push(`<p style="margin: 0; padding: 0 0 5px;">${value}</p>`);
                                }
                            };                        
                        }
                    }
                };
                table.push('</div>')
				const { lng, lat } = e.lngLat.wrap();
				tooltip.setLngLat([lng, lat]).setHTML(table.join(''));
				if (!tooltip.isOpen()) tooltip.addTo(map);

            });
           
            map.on('click', click_layers, (e) => {
                console.log(draw.getMode());
                if (draw.getMode() == 'simple_select') {
                    if (allow_click){
                        let table = ['<div style="line-height: 100%">']
                        for (layer_name of click_layers) {
                            layer = layer_name.split('@')[0];
                            if (map.getLayoutProperty(layer_name, 'visibility') == 'visible'){
                                feature = map.queryRenderedFeatures(e.point, {layers: [layer_name]})[0]
                                if (feature) {
                                    console.log(feature)
                                    table.push(`<h3>${layers[layer].name}</h3>`)
                                    const click_cats = layers[layer]['click'];
                                    for (let [cat, args] of Object.entries(click_cats)){
                                        let value = feature.properties[cat];
                                        if (value||value == 0){
                                            if(args[0]){
                                                if(args[1]==""){
                                                    table.push(`<h4>${cat}</h4>`);
                                                } else{
                                                    table.push(`<h4>${args[1]}</h4>`);
                                                }
                                            }
                                            table.push(`<p>${value}</p>`);
                                        }
                                    };                        
                                }
                            }
                        };
                        table.push('</div>')
                        new mapboxgl.Popup({className: 'popup-box', anchor:'top-left'})
                        .setLngLat(e.lngLat)
                        .setHTML(table.join(''))
                        .addTo(map);
                        
                    } else {
                        allow_click = true;
                    };
                    
                } else {
                    allow_click = false;
                };
            });

            //Code for mobile optimization for enabling the touch and zoom functions
            map.on('touchstart', click_layers, (e) => {
                console.log(draw.getMode());
                if (draw.getMode() == 'simple_select') {
                    if (allow_click){
                        let table = ['<div style="line-height: 100%">']
                        for (layer_name of click_layers) {
                            layer = layer_name.split('@')[0];
                            if (map.getLayoutProperty(layer_name, 'visibility') == 'visible'){
                                feature = map.queryRenderedFeatures(e.point, {layers: [layer_name]})[0]
                                if (feature) {
                                    console.log(feature)
                                    table.push(`<h3>${layers[layer].name}</h3>`)
                                    const click_cats = layers[layer]['click'];
                                    for (let [cat, args] of Object.entries(click_cats)){
                                        let value = feature.properties[cat];
                                        if (value||value == 0){
                                            if(args[0]){
                                                if(args[1]==""){
                                                    table.push(`<h4>${cat}</h4>`);
                                                } else{
                                                    table.push(`<h4>${args[1]}</h4>`);
                                                }
                                            }
                                            table.push(`<p>${value}</p>`);
                                        }
                                    };                        
                                }
                            }
                        };
                        table.push('</div>')
                        const touch_screen = new mapboxgl.Popup({className: 'popup-box', anchor:'top-left'}).trackPointer()
                        touch_screen.addTo(map)
                        .setLngLat(e.lngLat)
                        .setHTML(table.join(''))
                        .addTo(map);

                        map.on('touchstart', click_layers, (e) => {
                            touch_screen.remove()
                        });

                    } else {
                        allow_click = true;
                    };
                    
                } else {
                    allow_click = false;
                };
            });

            //Code for mobile optimization for enabling the touch and zoom functions
            map.on('touchmove', click_layers, (e) => {
                console.log(draw.getMode());
                if (draw.getMode() == 'simple_select') {
                    if (allow_click){
                        let table = ['<div style="line-height: 100%">']
                        for (layer_name of click_layers) {
                            layer = layer_name.split('@')[0];
                            if (map.getLayoutProperty(layer_name, 'visibility') == 'visible'){
                                feature = map.queryRenderedFeatures(e.point, {layers: [layer_name]})[0]
                                if (feature) {
                                    console.log(feature)
                                    table.push(`<h3>${layers[layer].name}</h3>`)
                                    const click_cats = layers[layer]['click'];
                                    for (let [cat, args] of Object.entries(click_cats)){
                                        let value = feature.properties[cat];
                                        if (value||value == 0){
                                            if(args[0]){
                                                if(args[1]==""){
                                                    table.push(`<h4>${cat}</h4>`);
                                                } else{
                                                    table.push(`<h4>${args[1]}</h4>`);
                                                }
                                            }
                                            table.push(`<p>${value}</p>`);
                                        }
                                    };                        
                                }
                            }
                        };
                        table.push('</div>')
                        new mapboxgl.Popup({className: 'popup-box', anchor:'top-left'})
                        .setLngLat(e.lngLat)
                        .addTo(map);
                        
                        touch_screen.setHTML(table.join(''));
                        if (!touch_screen.isOpen()){touch_screen.addTo(map)}
                        
                    } else {
                        allow_click = true;
                    };
                    
                } else {
                    allow_click = false;
                };
            });

            function updateLayerFilter(evt) {
                // get an array of icon names that corresponds to the currently checked checkboxes
                const splits = evt.currentTarget.id.split('@');
                const cat = splits[1];
                const layer = splits[0];
                var checkedSymbols = [...evt.currentTarget.parentNode.querySelectorAll('input')]
                .filter((el) => el.checked)
                .map((el) => el.id.split('@')[2]);
                const j = Object.keys(layers[layer].cat_filters).indexOf(cat) + 1;
                var tempList = [];
                for (sym of checkedSymbols){
                    const tempNum = Number(sym);
                    if (tempNum||tempNum==0){
                        tempList.push(tempNum);
                    }
                }
                const clear_btn = document.getElementById(layer.concat('@',cat,'@clear'));

                if (checkedSymbols.length < 1) {
                    //dummy filter that will match everything to clear previous filter
                    layers[layer].filters[j] = ['!=', cat, '!!!'];
                    clear_btn.classList.add('hide');
                }
                else {
                    layers[layer].filters[j] = ['in', cat, ...checkedSymbols, ...tempList];
                    //toggle on clear button, if not already
                    if (clear_btn.classList.contains('hide')) {clear_btn.classList.remove('hide')};
                }
                console.log(layers[layer].filters)
                for (type of layer_types){
                    if (layers[layer][type]){
                        map.setFilter(layer.concat('@',type), layers[layer].filters);                  
                    }
                };            
                
            };
            
            map.on('idle',function(){
                console.log('idle')
                if (init_filters) {
                    console.log('through')
                    init_filters = false;
                    hover_layers.reverse();
                    click_layers.reverse();
                    for (const layer of Object.keys(layers)){
                        console.log(layers[layer].source_id)

                        const layer_div = document.createElement('div');
                        layer_div.classList.add('dropdown');
                        layer_list.appendChild(layer_div);

                        const toggle_checkbox = document.createElement('input')
                        toggle_checkbox.type = 'checkbox';
                        toggle_checkbox.classList.add('toggle_checkbox');
                        toggle_checkbox.id = layer.concat('@toggle');
                        console.log(layers[layer].visible);
                        if (layers[layer].visible){
                            toggle_checkbox.checked = true;
                        }else {
                            for (type of layer_types){
                                if (layers[layer][type]){
                                    map.setLayoutProperty(layer.concat('@',type), 'visibility', 'none');                 
                                }
                            };
                        };
                        toggle_checkbox.addEventListener("change", function() {
                            const layer_id = this.id.split('@')[0]
                            const legend_div = document.getElementById('legend@'.concat(layer_id));
                            console.log(this.checked)
                            if (!this.checked){
                                for (type of layer_types){
                                    if (layers[layer][type]){
                                        map.setLayoutProperty(layer_id.concat('@',type), 'visibility', 'none');                 
                                    }
                                };
                                if (legend_div){legend_div.classList = 'legend';}
                            } else{
                                for (type of layer_types){
                                    if (layers[layer][type]){
                                        map.setLayoutProperty(layer_id.concat('@',type), 'visibility', 'visible');                 
                                    }
                                };
                                if (legend_div){legend_div.classList = 'legend show_filters';}
                            }
                        });
                        layer_div.appendChild(toggle_checkbox);
                        if (layers[layer].cat_filters ||layers[layer].num_filters ){
                            const dropdown_arrow = document.createElement('div')
                            dropdown_arrow.classList.add('dropdown_arrow','fa-solid','fa-caret-right');
                            dropdown_arrow.addEventListener('click',function(){
                                this.nextElementSibling.click()
                             });
                            layer_div.appendChild(dropdown_arrow);
                        }
            
                        const layer_button = document.createElement('button');
                        layer_button.classList.add('dropbtn');
                        layer_button.textContent = layers[layer].name;
                        layer_button.addEventListener("click", function() {
                            this.classList.toggle("active");
                            this.nextElementSibling.classList.toggle('show_filters');
                            const dropdown_arrow = this.previousElementSibling;
                            //toggle the dropdown arrow
                            if(dropdown_arrow.classList.contains('fa-caret-right')){
                                dropdown_arrow.classList.remove('fa-solid','fa-caret-right','dropdown_arrow') 
                                dropdown_arrow.classList.add('fa-solid','fa-caret-down','dropdown_arrow')
                            }else{
                                dropdown_arrow.classList.remove('fa-solid','fa-caret-down','dropdown_arrow') 
                                dropdown_arrow.classList.add('fa-solid','fa-caret-right','dropdown_arrow')
                            }
                        });
                        layer_div.appendChild(layer_button);

                        const layer_dropdown = document.createElement('div');
                        layer_dropdown.classList.add('filters');
                        layer_div.appendChild(layer_dropdown);

                        layers[layer]['filters'] = ['all']
                        if (layers[layer].cat_filters) {
                            for (const cat in layers[layer].cat_filters){
                                console.log(cat);
                                const vals = layers[layer].cat_filter_vals[cat];
                                layers[layer].filters.push(['!=', cat, '!!!']);

                                //add div,button, dropdown_content, and search input
                                const div = document.createElement('div');
                                div.classList.add('dropdown');
                                layer_dropdown.appendChild(div);

                                const clear = document.createElement('button');
                                clear.classList.add('clearbtn', 'hide');
                                clear.id = layer.concat('@',cat,'@clear');
                                clear.textContent = 'Clear';
                                clear.addEventListener("click", function() {
                                    for (checkbox of [...this.parentNode.querySelectorAll('input')].filter((el) => el.checked)) {
                                        checkbox.click();
                                    }
                                });
                                div.appendChild(clear);

                                const button = document.createElement('button');
                                button.classList.add('dropbtn', 'gray');
                                var name = layers[layer].cat_filters[cat];
                                if (name == "") name = cat;
                                button.textContent = name;
                                button.addEventListener("click", function() {
                                    this.classList.toggle("active");
                                    this.nextElementSibling.classList.toggle('show');
                                });
                                div.appendChild(button);

                                const dropdown_content = document.createElement('div');
                                dropdown_content.classList.add('dropdown-content');
                                dropdown_content.id = layer.concat('@', cat);
                                div.appendChild(dropdown_content);

                                if (vals.length > 5) {
                                    const search = document.createElement('input');
                                    search.type = 'text'
                                    search.placeholder = 'Search...'
                                    search.addEventListener('keyup', function() {
                                        var filter_str, a, i;
                                        filter_str = this.value.toUpperCase();
                                        console.log(filter_str)
                                        a = this.parentElement.getElementsByTagName("label");
                                        for (i = 0; i < a.length; i++) {
                                            txtValue = a[i].textContent || a[i].innerText;
                                            //|| this.parentElement.getElementById(txtValue).checked
                                            if (txtValue.toUpperCase().indexOf(filter_str) == 0 || document.getElementById(this.parentElement.id.concat('@',txtValue)).checked == true) {
                                                a[i].style.display = "";
                                            } else {
                                                a[i].style.display = "none";
                                            }
                                        }
                                    });
                                    dropdown_content.appendChild(search); 
                                };
                                    
                                console.log(vals)
                                for (const val of vals) {
                                    const input = document.createElement('input');
                                    input.type = 'checkbox';
                                    input.id = layer.concat('@',cat,'@',val);
                                    input.checked = false;
                                    dropdown_content.appendChild(input);
                                    
                                    const label = document.createElement('label');
                                    label.setAttribute('for', layer.concat('@',cat,'@',val));
                                    label.textContent = val;
                                    dropdown_content.appendChild(label);
                                    
                                    // When any checkbox changes, update the filter.
                                    input.addEventListener('change', updateLayerFilter);
                                };
                            }
                        }

                        if (layers[layer].num_filters) {
                            console.log(layers[layer].num_filters)
                            for (const cat in layers[layer].num_filters){
                                console.log(cat);
                                const min = layers[layer].num_filter_vals[cat][0];
                                const max = layers[layer].num_filter_vals[cat][1];
                                layers[layer].filters.push(['>=', cat, min]);
                                layers[layer].filters.push(['<=', cat, max]);
                                console.log(layers[layer].filters)
                                
                                //add div,button, dropdown_content, and search input
                                const div = document.createElement('div');
                                div.classList.add('dropdown');
                                layer_dropdown.appendChild(div);

                                const clear = document.createElement('button');
                                clear.classList.add('clearbtn', 'hide');
                                clear.id = layer.concat('@',cat,'@clear');
                                clear.textContent = 'Clear';
                                
                                clear.addEventListener("click", function() {
                                    const splits = this.id.split('@');
                                    const cat = splits[1];
                                    const layer = splits[0];
                                    var j = 1  + Object.keys(layers[layer].num_filters).indexOf(cat)*2;
                                    if (layers[layer].cat_filters) j = j + Object.keys(layers[layer].cat_filters).length;
                                    this.classList.add('hide');
                                    layers[layer].filters[j][2] = min;
                                    layers[layer].filters[j+1][2] = max;
                                    const fromInput = document.getElementById(layer.concat('@',cat,'@from@input'))
                                    fromInput.value = min;
                                    document.getElementById(layer.concat('@',cat,'@from@slider')).value = min;
                                    const toInput = document.getElementById(layer.concat('@',cat,'@to@input'));
                                    toInput.value = max;
                                    const toSlider = document.getElementById(layer.concat('@',cat,'@to@slider'));
                                    toSlider.value = max;
                                    fillSlider(fromInput, toInput, '#C6C6C6', '#128ed6', toSlider);
                                    console.log(layers[layer].filters);
                                    for (type of layer_types){
                                        if (layers[layer][type]){
                                            map.setFilter(layer.concat('@',type), layers[layer].filters);                  
                                        }
                                    };
                                });
                                
                                div.appendChild(clear);

                                const button = document.createElement('button');
                                button.classList.add('dropbtn', 'gray');
                                var name = layers[layer].num_filters[cat]
                                if (name == "") name = cat;
                                button.textContent = name;
                                button.addEventListener("click", function() {
                                    this.classList.toggle("active");
                                    this.nextElementSibling.classList.toggle('show');
                                });
                                div.appendChild(button);

                                const dropdown_content = document.createElement('div');
                                dropdown_content.classList.add('dropdown-content');
                                dropdown_content.id = layer.concat('@', cat);
                                div.appendChild(dropdown_content);

                                const range_container = document.createElement('div');
                                range_container.classList.add('range_container');
                                dropdown_content.appendChild(range_container); 
                                
                                const slider_div = document.createElement('div');
                                slider_div.classList.add('slider_control');
                                range_container.appendChild(slider_div); 

                                const from_slider = document.createElement('input');
                                from_slider.type = 'range';
                                from_slider.id = layer.concat('@',cat,'@from@slider');
                                from_slider.style.zIndex = 1;
                                from_slider.style.height = 0;
                                from_slider['min'] = min;
                                from_slider['max'] = max;
                                from_slider.value = min;
                                slider_div.appendChild(from_slider); 

                                

                                const to_slider = document.createElement('input');
                                to_slider.type = 'range';
                                to_slider.id = layer.concat('@',cat,'@to@slider');
                                to_slider['min'] = min;
                                to_slider['max'] = max;
                                to_slider.value = max;
                                slider_div.appendChild(to_slider); 

                                const form_control = document.createElement('div');
                                form_control.classList.add('form_control');
                                range_container.appendChild(form_control);

                                const length = Math.max(min.toString().length, max.toString().length) + 2
                                const width = Math.min(100, Math.round(length/9 * 100))
                                const width_str = width + "px"

                                const from = document.createElement('input');
                                from.type = 'number';
                                from.id = layer.concat('@',cat,'@from@input');
                                from.style.width = width_str;
                                from.value = min;
                                from['min'] = min;
                                from['max'] = max;
                                form_control.appendChild(from); 

                                const to = document.createElement('input');
                                to.type = 'number';
                                to.id = layer.concat('@',cat,'@to@input');
                                to.style.width = width_str;
                                to.value = max;
                                to['min'] = min;
                                to['max'] = max;
                                form_control.appendChild(to); 

                                fillSlider(from, to, '#C6C6C6', '#128ed6', to_slider);
                                from_slider.oninput = () => controlFromSlider(from_slider, to_slider, from);
                                to_slider.oninput = () => controlToSlider(from_slider, to_slider, to);
                                from.oninput = () => controlFromInput(from_slider, from, to, to_slider);
                                to.oninput = () => controlToInput(to_slider, from, to, to_slider);

                                //from.addEventListener('change', updateNumericFilter);
                                //to.addEventListener('change', updateNumericFilter);
                                    
                            }
                        }
			            if(layers[layer].perm_filters){
                            layers[layer].filters=layers[layer].filters.concat(layers[layer].perm_filters); 
                        } 
                        for (type of layer_types){
                            if (layers[layer][type]){
                                map.setFilter(layer.concat('@',type), layers[layer].filters);                   
                            }
                         };  
                    }
                }
            });
        });
        window.addEventListener('resize',()=>{
        map.resize();
        })  
    });
</script>

</body>
</html>



